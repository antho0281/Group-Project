#MAKE SURE JUPYTER FILE AND EXCEL WORKBOOK ARE IN SAME FOLDER ON PC
from openpyxl import load_workbook
from datetime import datetime

calendar = []  # list of event dictionaries

def load_calendar(filename="calendar.xlsx"):
    global calendar
    calendar = []
    try:
        wb = load_workbook(filename)
        sheet = wb.active
        
        for row in sheet.iter_rows(min_row=2, values_only=True):
            event, date_str, description, email = row
            calendar.append({
                "event": event,
                "date": date_str,
                "description": description,
                "email": email
            })
        print("‚úÖ Calendar loaded from Excel!")
    except FileNotFoundError:
        print("‚ö†Ô∏è No Excel calendar found yet.")

from openpyxl import Workbook

def save_calendar(filename="calendar.xlsx"):
    wb = Workbook()
    sheet = wb.active
    sheet.append(["Event", "Date", "Description", "Email"])  # header

    for item in calendar:
        sheet.append([item["event"], item["date"], item["description"], item["email"]])

    wb.save(filename)
    print("‚úÖ Calendar saved to Excel!")
    
def add_event():
    event = input("Event name: ")
    date = input("Date and time (YYYY-MM-DD HH:MM): ")
    description = input("Description: ")
    email = input("Email to notify: ")
    calendar.append({
        "event": event,
        "date": date,
        "description": description,
        "email": email
    })
    print("‚úÖ Event Added!\n")

from datetime import timedelta
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

def send_email(to_email, subject, body):
    sender_email = "testaccount05@gmail.com" # USE GMAIL ACCOUNT #STILL DEBUGGING
    sender_password = "Python08"  # Use Gmail App Password

    msg = MIMEMultipart()
    msg["From"] = sender_email
    msg["To"] = to_email
    msg["Subject"] = subject
    msg.attach(MIMEText(body, "plain"))

    with smtplib.SMTP("smtp.gmail.com", 587) as server:
        server.starttls()
        server.login(sender_email, sender_password)
        server.send_message(msg)

def check_reminders():
    now = datetime.now()
    for item in calendar:
        event_time = datetime.strptime(item["date"], "%Y-%m-%d %H:%M")
        time_until = event_time - now

        if timedelta(hours=0) < time_until <= timedelta(days=1):
            subject = f"Reminder: {item['event']} is coming up!"
            body = (f"Reminder: '{item['event']}' is scheduled for "
                    f"{event_time.strftime('%Y-%m-%d %H:%M')}\n\nDetails: {item['description']}")
            send_email(item["email"], subject, body)
            print(f"üìß Reminder sent for {item['event']}!")

def main():
    load_calendar()
    while True:
        print("\n==== Reminder Calendar ====")
        print("1. Add Event")
        print("2. Save and Exit")
        print("3. Check Reminders")
        choice = input("Choose an option: ")

        if choice == "1":
            add_event()
        elif choice == "2":
            save_calendar()
            break
        elif choice == "3":
            check_reminders()
        else:
            print("Invalid choice.")
            
main()
